<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIACOMO ‚Äî Emergency Medical Profile</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap">
    <style>
        /* Essential styles for the Impact Clock */
        .impact-clock-box {
            background: rgba(255, 46, 67, 0.1);
            border: 1px solid var(--danger);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none; /* Hidden by default */
        }
        .clock-label { font-size: 10px; font-weight: 800; color: var(--danger); letter-spacing: 1px; }
        .clock-time { font-size: 24px; font-weight: 900; color: #fff; display: block; }
    </style>
</head>
<body class="emergency-body">
    <div class="emergency-card">
        <div id="impact-section" class="impact-clock-box">
            <span class="clock-label">‚ö†Ô∏è IMPACT DETECTED AT</span>
            <span id="impact-time" class="clock-time">--:--:--</span>
        </div>

        <div class="emergency-header">
            <div class="medical-icon">üè•</div>
            <h1 id="rider-name">Loading...</h1>
            <p>EMERGENCY MEDICAL PROFILE</p>
        </div>

        <div class="info-box">
            <div class="info-row">
                <span class="info-label">Blood Type</span>
                <div id="blood-type" class="blood-badge">--</div>
            </div>

            <div class="info-row">
                <span class="info-label">Medical Allergies</span>
                <div id="allergies" class="info-value">--</div>
            </div>

            <div class="info-row">
                <span class="info-label">Chronic Conditions</span>
                <div id="chronic-conditions" class="info-value">--</div>
            </div>

            <div class="info-row">
                <span class="info-label">Organ Donor</span>
                <div id="organ-donor" class="info-value">--</div>
            </div>

            <div class="contact-box">
                <span class="info-label" style="color:var(--danger)">Emergency Contacts</span>
                
                <div id="contact-1" class="ice-entry">
                    <div id="c1-name" class="info-value">--</div>
                    <a id="c1-link" href="#" class="call-btn">üìû CALL</a>
                </div>

                <div id="contact-2" class="ice-entry" style="margin-top:10px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                    <div id="c2-name" class="info-value">--</div>
                    <a id="c2-link" href="#" class="call-btn">üìû CALL</a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './js/supabaseClient.js';

        const urlParams = new URLSearchParams(window.location.search);
        const riderId = urlParams.get('id');

        async function loadEmergencyData() {
            if (!riderId) return;

            // 1. Fetch Profile (for crash status and name)
            const { data: profile } = await supabase
                .from('profiles')
                .select('full_name, is_crashed')
                .eq('id', riderId)
                .single();

            if (profile) {
                document.getElementById('rider-name').innerText = profile.full_name;

                // 2. Handle Impact Clock (Option A)
                if (profile.is_crashed) {
                    const { data: log } = await supabase
                        .from('incident_logs')
                        .select('timestamp')
                        .eq('user_id', riderId)
                        .order('timestamp', { ascending: false })
                        .limit(1)
                        .single();

                    if (log) {
                        const time = new Date(log.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        document.getElementById('impact-time').innerText = time;
                        document.getElementById('impact-section').style.display = 'block';
                    }
                }
            }

            // 3. Fetch Medical Detailed Profile
            const { data: medical } = await supabase
                .from('medical_profiles')
                .select('*')
                .eq('user_id', riderId)
                .single();

            if (medical) {
                document.getElementById('blood-type').innerText = medical.blood_type || 'N/A';
                document.getElementById('allergies').innerText = medical.allergiestext || medical.allergies || 'None'; // Handling potential column naming variations
                document.getElementById('chronic-conditions').innerText = medical.chronic_conditions || 'None Reported';
                document.getElementById('organ-donor').innerText = medical.organ_donor ? 'YES' : 'NO';
                
                // Contact 1
                document.getElementById('c1-name').innerText = medical.contact_1_nametext || medical.contact_1_name || 'No Contact';
                document.getElementById('c1-link').href = `tel:${medical.contact_1_phonetext || medical.contact_1_phone}`;
                
                // Contact 2
                if (medical.contact_2_nametext || medical.contact_2_name) {
                    document.getElementById('c2-name').innerText = medical.contact_2_nametext || medical.contact_2_name;
                    document.getElementById('c2-link').href = `tel:${medical.contact_2_phonetext || medical.contact_2_phone}`;
                }
            }
        }

        loadEmergencyData();
    </script>
</body>
</html>